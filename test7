import warnings
warnings.filterwarnings("ignore")

from nba_api.stats.endpoints import ScoreboardV2, PlayerGameLog
from nba_api.stats.static import teams, players
import pandas as pd
import time
from datetime import datetime
from tabulate import tabulate
from reportlab.lib.pagesizes import letter
from reportlab.lib import colors
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
from reportlab.lib.styles import getSampleStyleSheet

# -----------------------------
# SETTINGS
# -----------------------------
NUM_GAMES = 10
SEASONS = ["2025-26", "2024-25"]
SEASON_TYPES = ["Regular Season", "Playoffs"]
HIT_RATE_CUTOFF = 70

POINT_THRESHOLDS = [10, 15, 20, 25, 30]
REB_THRESHOLDS   = [2, 4, 6, 8, 10]
AST_THRESHOLDS   = [2, 4, 6, 8, 10]
STL_THRESHOLDS   = [1, 2]
BLK_THRESHOLDS   = [1, 2]
THREEPM_THRESHOLDS = [1, 2, 3, 4, 5]

# -----------------------------
# TEAM PLAYERS (short example)
# -----------------------------
TEAM_PLAYERS = {
    "ATL": ["Trae Young", "Dejounte Murray", "Jalen Johnson", "Clint Capela", "Saddiq Bey", "Onyeka Okongwu"],
    "BOS": ["Jayson Tatum", "Jaylen Brown", "Kristaps Porzingis", "Jrue Holiday", "Derrick White", "Al Horford"],
    "BKN": ["Mikal Bridges", "Cam Thomas", "Ben Simmons", "Nic Claxton", "Dennis Schroder", "Dorian Finney-Smith"],
    "CHA": ["LaMelo Ball", "Brandon Miller", "Miles Bridges", "Mark Williams", "Nick Smith Jr.", "Grant Williams"],
    "CHI": ["Zach LaVine", "DeMar DeRozan", "Coby White", "Patrick Williams", "Nikola Vucevic", "Ayo Dosunmu"],
    "CLE": ["Donovan Mitchell", "Darius Garland", "Evan Mobley", "Jarrett Allen", "Max Strus", "Caris LeVert"],
    "DAL": ["Luka Doncic", "Kyrie Irving", "Cooper Flagg", "Dereck Lively II", "P.J. Washington", "Josh Green"],
    "DEN": ["Nikola Jokic", "Jamal Murray", "Aaron Gordon", "Michael Porter Jr.", "Kentavious Caldwell-Pope", "Christian Braun"],
    "DET": ["Cade Cunningham", "Jaden Ivey", "Jalen Duren", "Ausar Thompson", "Isaiah Stewart", "Simone Fontecchio"],
    "GSW": ["Stephen Curry", "Draymond Green", "Jonathan Kuminga", "Brandin Podziemski", "Andrew Wiggins", "Kevon Looney"],
    "HOU": ["Jalen Green", "Alperen Sengun", "Fred VanVleet", "Dillon Brooks", "Amen Thompson", "Cam Whitmore"],
    "IND": ["Tyrese Haliburton", "Myles Turner", "Bennedict Mathurin", "Jarace Walker", "Bruce Brown", "Andrew Nembhard"],
    "LAC": ["Paul George", "Kawhi Leonard", "James Harden", "Ivica Zubac", "Terance Mann", "Norman Powell"],
    "LAL": ["LeBron James", "Anthony Davis", "Austin Reaves", "Rui Hachimura", "Gabe Vincent", "Spencer Dinwiddie"],
    "MEM": ["Ja Morant", "Desmond Bane", "Jaren Jackson Jr.", "Marcus Smart", "Santi Aldama", "Luke Kennard"],
    "MIA": ["Jimmy Butler", "Bam Adebayo", "Tyler Herro", "Terry Rozier", "Jaime Jaquez Jr.", "Caleb Martin"],
    "MIL": ["Giannis Antetokounmpo", "Damian Lillard", "Khris Middleton", "Brook Lopez", "Bobby Portis", "Malik Beasley"],
    "MIN": ["Anthony Edwards", "Karl-Anthony Towns", "Rudy Gobert", "Mike Conley", "Jaden McDaniels", "Naz Reid"],
    "NOP": ["Zion Williamson", "Brandon Ingram", "CJ McCollum", "Herbert Jones", "Trey Murphy III", "Jonas Valanciunas"],
    "NYK": ["Jalen Brunson", "Julius Randle", "RJ Barrett", "OG Anunoby", "Josh Hart", "Mitchell Robinson"],
    "OKC": ["Shai Gilgeous-Alexander", "Chet Holmgren", "Jalen Williams", "Josh Giddey", "Luguentz Dort", "Isaiah Joe"],
    "ORL": ["Paolo Banchero", "Franz Wagner", "Wendell Carter Jr.", "Jalen Suggs", "Cole Anthony", "Jonathan Isaac"],
    "PHI": ["Joel Embiid", "Tyrese Maxey", "Tobias Harris", "Kelly Oubre Jr.", "Kyle Lowry", "Ricky Council IV"],
    "PHX": ["Kevin Durant", "Devin Booker", "Bradley Beal", "Grayson Allen", "Jusuf Nurkic", "Eric Gordon"],
    "POR": ["Scoot Henderson", "Anfernee Simons", "Jerami Grant", "Deandre Ayton", "Shaedon Sharpe", "Matisse Thybulle"],
    "SAC": ["De‚ÄôAaron Fox", "Domantas Sabonis", "Keegan Murray", "Malik Monk", "Harrison Barnes", "Kevin Huerter"],
    "SAS": ["Victor Wembanyama", "Devin Vassell", "Zach Collins", "Keldon Johnson", "Jeremy Sochan", "Malaki Branham"],
    "TOR": ["Scottie Barnes", "RJ Barrett", "Immanuel Quickley", "Jakob Poeltl", "Gradey Dick", "Kelly Olynyk"],
    "UTA": ["Lauri Markkanen", "Walker Kessler", "Collin Sexton", "John Collins", "Keyonte George", "Jordan Clarkson"],
    "WAS": ["Jordan Poole", "Kyle Kuzma", "Deni Avdija", "Tyus Jones", "Bilal Coulibaly", "Marvin Bagley III"],
}

# -----------------------------
# FUNCTIONS
# -----------------------------
def get_todays_games():
    today = datetime.now().strftime("%m/%d/%Y")
    scoreboard = ScoreboardV2(game_date=today)
    games = scoreboard.game_header.get_data_frame()
    team_lookup = {t["id"]: t["abbreviation"] for t in teams.get_teams()}
    matchups = []
    for _, row in games.iterrows():
        home_abbrev = team_lookup.get(row["HOME_TEAM_ID"], "UNK")
        away_abbrev = team_lookup.get(row["VISITOR_TEAM_ID"], "UNK")
        matchups.append({"game_id": row["GAME_ID"], "home_team": home_abbrev, "away_team": away_abbrev})
    return matchups

import json
import os
from datetime import datetime

CACHE_FILE = "player_logs_cache.json"

# -----------------------------
# CACHE FUNCTIONS
# -----------------------------
def load_cache():
    """Load existing cache from disk."""
    if os.path.exists(CACHE_FILE):
        try:
            with open(CACHE_FILE, "r") as f:
                return json.load(f)
        except:
            return {}
    return {}

def save_cache(cache):
    """Save updated cache to disk."""
    with open(CACHE_FILE, "w") as f:
        json.dump(cache, f, indent=2, default=str)

def get_recent_games_cached(player_name, player_id):
    """Return last 10 games, updating cache only if a new game is found."""
    cache = load_cache()
    player_cache = cache.get(player_name, [])

    # Convert cached games to DataFrame
    df_cached = pd.DataFrame(player_cache)

    # If we already have cached data, check the latest date
    if not df_cached.empty:
        last_cached_date = pd.to_datetime(df_cached["GAME_DATE"].max())
    else:
        last_cached_date = pd.Timestamp(0)

    # Fetch recent games (API)
    fetched_df = pd.DataFrame()
    for season in SEASONS:
        for stype in SEASON_TYPES:
            try:
                logs = PlayerGameLog(player_id=player_id, season=season, season_type_all_star=stype).get_data_frames()[0]
                fetched_df = pd.concat([fetched_df, logs], ignore_index=True)
                time.sleep(0.25)
            except:
                pass

    if fetched_df.empty:
        # If nothing fetched, just return cache
        return df_cached.head(NUM_GAMES)

    fetched_df["GAME_DATE"] = pd.to_datetime(fetched_df["GAME_DATE"])
    fetched_df = fetched_df[["GAME_DATE", "MATCHUP", "PTS", "REB", "AST", "STL", "BLK", "FG3M"]]
    fetched_df.sort_values("GAME_DATE", ascending=False, inplace=True)

    # Identify new games not in cache
    new_games = fetched_df[fetched_df["GAME_DATE"] > last_cached_date]

    if not new_games.empty:
        print(f"  ‚ôªÔ∏è Updating cache for {player_name} with {len(new_games)} new games.")
        combined = pd.concat([new_games, df_cached], ignore_index=True)
        combined = combined.drop_duplicates(subset="GAME_DATE").sort_values("GAME_DATE", ascending=False).head(NUM_GAMES)
        cache[player_name] = combined.to_dict(orient="records")
        save_cache(cache)
        return combined
    else:
        # No new games; just return cache
        print(f"  üí§ Using cached data for {player_name}")
        return df_cached.head(NUM_GAMES)


def get_recent_games(player_id):
    all_logs = pd.DataFrame()
    for season in SEASONS:
        for stype in SEASON_TYPES:
            try:
                logs = PlayerGameLog(player_id=player_id, season=season, season_type_all_star=stype).get_data_frames()[0]
                all_logs = pd.concat([all_logs, logs], ignore_index=True)
                time.sleep(0.25)
            except:
                pass
    if all_logs.empty:
        return pd.DataFrame()
    all_logs["GAME_DATE"] = pd.to_datetime(all_logs["GAME_DATE"])
    all_logs = all_logs[["GAME_DATE", "MATCHUP", "PTS", "REB", "AST", "STL", "BLK", "FG3M"]]
    all_logs.sort_values("GAME_DATE", ascending=False, inplace=True)
    return all_logs.head(NUM_GAMES)

def hit_rate(series, threshold):
    hits = (series >= threshold).sum()
    pct = hits / len(series) * 100 if len(series) > 0 else 0
    return pct, hits, len(series)

def summarize_stat(df, stat_name, thresholds):
    results = []
    for t in thresholds:
        pct, hits, total = hit_rate(df[stat_name], t)
        if pct >= HIT_RATE_CUTOFF:
            results.append((t, pct, hits, total))
    if not results:
        return []
    highest = results[-1]
    output = [highest]
    max_100s = [r for r in results if r[1] == 100]
    if max_100s:
        top_100 = max_100s[-1]
        if top_100 not in output:
            output.insert(0, top_100)
    return output

# -----------------------------
# MAIN LOGIC
# -----------------------------
print("üìÖ Fetching today‚Äôs NBA games...\n")
matchups = get_todays_games()
if not matchups:
    print("‚ö†Ô∏è No NBA games found for today.")
    exit()

today_str = datetime.now().strftime("%Y-%m-%d")
pdf_filename = f"NBA_HitRates_{today_str}.pdf"

doc = SimpleDocTemplate(pdf_filename, pagesize=letter)
story = []
styles = getSampleStyleSheet()
story.append(Paragraph(f"NBA Hit Rate Report ‚Äì {today_str}", styles["Title"]))
story.append(Spacer(1, 12))

top_trends = []  # collect strongest props across all players

for game in matchups:
    away_team, home_team = game["away_team"], game["home_team"]
    print(f"\n==================== {away_team}@{home_team} ====================")
    story.append(Paragraph(f"<b>{away_team} @ {home_team}</b>", styles["Heading2"]))

    for team_abbr in [away_team, home_team]:
        if team_abbr not in TEAM_PLAYERS:
            story.append(Paragraph(f"Skipping {team_abbr} (no players defined)", styles["Normal"]))
            continue

        story.append(Paragraph(f"<b>{team_abbr} players:</b>", styles["Heading3"]))
        for player_name in TEAM_PLAYERS[team_abbr]:
            print(f"  ‚è≥ {player_name}...")
            found = players.find_players_by_full_name(player_name)
            if not found:
                continue
            player_id = found[0]["id"]
            df = get_recent_games_cached(player_name, player_id)
            if df.empty:
                continue

            categories = [
                ("PTS", POINT_THRESHOLDS, "Points"),
                ("REB", REB_THRESHOLDS, "Rebounds"),
                ("AST", AST_THRESHOLDS, "Assists"),
                ("STL", STL_THRESHOLDS, "Steals"),
                ("BLK", BLK_THRESHOLDS, "Blocks"),
                ("FG3M", THREEPM_THRESHOLDS, "3PM"),
            ]

            table_data = [["Stat", "Threshold", "Hits", "Rate"]]
            for stat, thresholds, label in categories:
                res = summarize_stat(df, stat, thresholds)
                for t, pct, hits, total in res:
                    table_data.append([label, f"{t}+", f"{hits}/{total}", f"{pct:.0f}%"])
                    top_trends.append({
                        "player": player_name,
                        "team": team_abbr,
                        "label": label,
                        "threshold": t,
                        "pct": pct
                    })

            if len(table_data) > 1:
                t = Table(table_data)
                t.setStyle(TableStyle([
                    ("BACKGROUND", (0, 0), (-1, 0), colors.lightgrey),
                    ("GRID", (0, 0), (-1, -1), 0.5, colors.grey),
                    ("FONTNAME", (0, 0), (-1, 0), "Helvetica-Bold"),
                ]))
                story.append(Paragraph(f"<b>{player_name}</b>", styles["Normal"]))
                story.append(t)
                story.append(Spacer(1, 6))

# -----------------------------
# SUMMARY OF TOP TRENDS
# -----------------------------
if top_trends:
    top_sorted = sorted(top_trends, key=lambda x: x["pct"], reverse=True)[:25]
    story.append(Spacer(1, 12))
    story.append(Paragraph("<b>Top Hit Rate Trends</b>", styles["Heading2"]))

    summary_data = [["Player", "Team", "Stat", "Threshold", "Hit Rate"]]
    for t in top_sorted:
        summary_data.append([
            t["player"], t["team"], t["label"], f"{t['threshold']}+", f"{t['pct']:.0f}%"
        ])

    summary_table = Table(summary_data)
    summary_table.setStyle(TableStyle([
        ("BACKGROUND", (0, 0), (-1, 0), colors.lightgrey),
        ("GRID", (0, 0), (-1, -1), 0.5, colors.grey),
        ("FONTNAME", (0, 0), (-1, 0), "Helvetica-Bold"),
    ]))
    story.append(summary_table)

doc.build(story)
print(f"\n‚úÖ Report saved to {pdf_filename}")
