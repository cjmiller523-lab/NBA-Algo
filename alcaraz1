import requests
import pandas as pd
from io import StringIO

# =============================
# CONFIG
# =============================
PLAYER = "Carlos Alcaraz"
MATCHES = 30

HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                  "AppleWebKit/537.36 (KHTML, like Gecko) "
                  "Chrome/120.0.0.0 Safari/537.36"
}

# =============================
# HELPERS
# =============================
def player_to_slug(name):
    first, last = name.split(" ", 1)
    return f"{last}{first}"

def normalize_surface(s):
    s = str(s).lower()
    if "clay" in s:
        return "Clay"
    if "grass" in s:
        return "Grass"
    if "indoor" in s:
        return "Indoor Hard"
    return "Hard"

def get_total_games(row):
    for col in ["Gms", "Games", "Total"]:
        if col in row and pd.notna(row[col]):
            try:
                return int(row[col])
            except:
                pass

    for w_col, l_col in [("W1", "L1"), ("W", "L")]:
        if w_col in row and l_col in row:
            try:
                return int(row[w_col]) + int(row[l_col])
            except:
                pass

    return None

# =============================
# MAIN
# =============================
def main():
    slug = player_to_slug(PLAYER)
    url = f"https://www.tennisabstract.com/cgi-bin/player.cgi?p={slug}&f=AMatchStats"

    html = requests.get(url, headers=HEADERS, timeout=20).text

    # ðŸ”‘ HEADER FIX IS HERE
    tables = pd.read_html(StringIO(html), header=1)

    print(f"\n[DEBUG] Total tables found: {len(tables)}")

    df = max(tables, key=len).copy()

    print("\n[DEBUG] Columns found:")
    print(df.columns.tolist())

    df = df.head(MATCHES)

    rows = []

    for _, r in df.iterrows():
        sv_g = r.get("SvG")
        sv_bp = r.get("SvBP")
        rt_g = r.get("RtG")
        rt_bp = r.get("RtBP")

        if pd.isna(sv_g) or pd.isna(rt_g):
            continue

        total_games = get_total_games(r)
        if total_games is None:
            continue

        hold = (sv_g - sv_bp) / sv_g if sv_g else None
        brk = rt_bp / rt_g if rt_g else None

        rows.append({
            "date": r.get("Date"),
            "surface": normalize_surface(r.get("Surface")),
            "opponent": r.get("Opp"),
            "hold_pct": round(hold * 100, 1) if hold is not None else None,
            "break_pct": round(brk * 100, 1) if brk is not None else None,
            "total_games": total_games
        })

    out = pd.DataFrame(rows)

    if out.empty:
        print(f"\nâŒ No usable match rows parsed for {PLAYER}")
        return

    print(f"\nðŸŽ¾ LAST {len(out)} MATCHES â€” {PLAYER}\n")
    print(out.to_string(index=False))

    print("\nðŸ“Š HIT RATE SNAPSHOT")
    print("-------------------")
    print(f"22+ games: {(out['total_games'] >= 22).sum()} / {len(out)}")
    print(f"25+ games: {(out['total_games'] >= 25).sum()} / {len(out)}")
    print(f"Hold â‰¥80%: {(out['hold_pct'] >= 80).sum()} / {len(out)}")
    print(f"Break â‰¥20%: {(out['break_pct'] >= 20).sum()} / {len(out)}")

# =============================
# RUN
# =============================
if __name__ == "__main__":
    main()
